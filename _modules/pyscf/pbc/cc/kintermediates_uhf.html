

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyscf.pbc.cc.kintermediates_uhf &mdash; PySCF 1.7.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> PySCF
          

          
          </a>

          
            
            
              <div class="version">
                1.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">1. An overview of PySCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../version.html">2. Version history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">3. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code-rule.html">4. Code standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../benchmark.html">5. Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">6. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../theory.html">7. Theoretical methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced.html">8. Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../interface.html">9. Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">10. Main modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">PySCF</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>pyscf.pbc.cc.kintermediates_uhf</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyscf.pbc.cc.kintermediates_uhf</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">pyscf.pbc.lib</span> <span class="k">import</span> <span class="n">kpts_helper</span>

<span class="n">einsum</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span>

<span class="c1">#FIXME: the dtype of each intermediates. When the khf is at gamma point, the</span>
<span class="c1"># dtype is inconsistent between intermediates and t amplitudes</span>

<span class="k">def</span> <span class="nf">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1p</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t2aa</span><span class="p">)</span>

    <span class="n">tauaa</span> <span class="o">=</span> <span class="n">t2aa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tauab</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">taubb</span> <span class="o">=</span> <span class="n">t2bb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ib,ja-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ja,ib-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>

            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ib,ja-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ja,ib-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>
            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>

            <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span>

<span class="k">def</span> <span class="nf">make_tau2</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1p</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t2aa</span><span class="p">)</span>

    <span class="n">tauaa</span> <span class="o">=</span> <span class="n">t2aa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tauab</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">taubb</span> <span class="o">=</span> <span class="n">t2bb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>

            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>

            <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">])</span>
            <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ia-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">fac</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">kj</span><span class="p">],</span> <span class="n">t1p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ki</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span>

<span class="k">def</span> <span class="nf">cc_Fvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nvir_a</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nocc_b</span><span class="p">,</span> <span class="n">nvir_b</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvir_a</span><span class="p">,</span><span class="n">nvir_a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvir_b</span><span class="p">,</span><span class="n">nvir_b</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="n">tau_tildeaa</span><span class="p">,</span><span class="n">tau_tildeab</span><span class="p">,</span><span class="n">tau_tildebb</span><span class="o">=</span><span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">fov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">:]</span>
    <span class="n">fOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">:]</span>
    <span class="n">fvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">nocc_a</span><span class="p">:,</span><span class="n">nocc_a</span><span class="p">:]</span>
    <span class="n">fVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">nocc_b</span><span class="p">:,</span><span class="n">nocc_b</span><span class="p">:]</span>

    <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">fvv</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">fVV</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span><span class="n">fov</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span><span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span><span class="n">fOV</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span><span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,fmea-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,emfa-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,fmea-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>

            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,fmea-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,emfa-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,fmea-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tau_tildeaa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
                <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaF,meNF-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tau_tildeab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tau_tildebb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
                <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MnFa,MFne-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tau_tildeab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fa</span><span class="p">,</span><span class="n">fb</span>


<span class="k">def</span> <span class="nf">cc_Foo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nvir_a</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nocc_b</span><span class="p">,</span> <span class="n">nvir_b</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="n">tau_tildeaa</span><span class="p">,</span><span class="n">tau_tildeab</span><span class="p">,</span><span class="n">tau_tildebb</span><span class="o">=</span><span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">fov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">:]</span>
    <span class="n">fOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">:]</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:</span><span class="n">nocc_a</span><span class="p">,:</span><span class="n">nocc_a</span><span class="p">]</span>
    <span class="n">fOO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:</span><span class="n">nocc_b</span><span class="p">,:</span><span class="n">nocc_b</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">foo</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">fOO</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ne-&gt;mn&#39;</span><span class="p">,</span><span class="n">fov</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span><span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ne-&gt;mn&#39;</span><span class="p">,</span><span class="n">fOV</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span><span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,mnoa-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,mnoa-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,onma-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,mnoa-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,mnoa-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;oa,onma-&gt;mn&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;inef,menf-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tau_tildeaa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
                <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNeF,meNF-&gt;mi&#39;</span><span class="p">,</span><span class="n">tau_tildeab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;INEF,MENF-&gt;MI&#39;</span><span class="p">,</span><span class="n">tau_tildebb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
                <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIeF,neMF-&gt;MI&#39;</span><span class="p">,</span><span class="n">tau_tildeab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fa</span><span class="p">,</span><span class="n">fb</span>


<span class="k">def</span> <span class="nf">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nvir_a</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nocc_b</span><span class="p">,</span> <span class="n">nvir_b</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">fov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">:]</span>
    <span class="n">fOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">:]</span>

    <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocc_a</span><span class="p">,</span><span class="n">nvir_a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocc_b</span><span class="p">,</span><span class="n">nvir_b</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">fov</span><span class="p">[</span><span class="n">km</span><span class="p">]</span>
        <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">fOV</span><span class="p">[</span><span class="n">km</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,mfne-&gt;me&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">+=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,nfme-&gt;me&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">km</span><span class="p">]</span><span class="o">-=</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,mfne-&gt;me&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fa</span><span class="p">,</span><span class="n">fb</span>

<span class="k">def</span> <span class="nf">cc_Woooo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>

    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">tau_aa</span><span class="p">,</span> <span class="n">tau_ab</span><span class="p">,</span> <span class="n">tau_bb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">tmp_aaaaJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_aaaaJ</span> <span class="o">-=</span> <span class="n">tmp_aaaaJ</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">tmp_bbbbJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_bbbbJ</span> <span class="o">-=</span> <span class="n">tmp_bbbbJ</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">tmp_aabbJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_baabJ</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yie,xmjne-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">]</span>

            <span class="n">ki</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)</span>
            <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_aaaaJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
            <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_bbbbJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_aabbJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp_baabJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yxijef,xmenf-&gt;yminj&#39;</span><span class="p">,</span> <span class="n">tau_aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yxijef,xmenf-&gt;yminj&#39;</span><span class="p">,</span> <span class="n">tau_bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yxijef,xmenf-&gt;yminj&#39;</span><span class="p">,</span> <span class="n">tau_ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">Woooo</span> <span class="o">-</span> <span class="n">Woooo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">WOOOO</span> <span class="o">-</span> <span class="n">WOOOO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Woooo</span><span class="p">,</span> <span class="n">WooOO</span><span class="p">,</span> <span class="n">WOOOO</span>


<span class="k">def</span> <span class="nf">cc_Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="c1">#:wvvvv = eris.vvvv.copy()</span>
    <span class="c1">#:Wvvvv += np.einsum(&#39;ymb,zyxemfa,zxyw-&gt;wzyaebf&#39;, t1a, eris.vovv.conj(), P)</span>
    <span class="c1">#:Wvvvv -= np.einsum(&#39;ymb,xyzfmea,xzyw-&gt;wzyaebf&#39;, t1a, eris.vovv.conj(), P)</span>
    <span class="c1">#:Wvvvv = Wvvvv - Wvvvv.transpose(2,1,0,5,4,3,6)</span>
    <span class="n">Wvvvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,emfa-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">Wvvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebf</span>
        <span class="n">Wvvvv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aebf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1">#:WvvVV = eris.vvVV.copy()</span>
    <span class="c1">#:WvvVV -= np.einsum(&#39;xma,zxwemFB,zwxy-&gt;xzyaeBF&#39;, t1a, eris.voVV.conj(), P)</span>
    <span class="c1">#:WvvVV -= np.einsum(&#39;yMB,wyzFMea,wzyx-&gt;xzyaeBF&#39;, t1b, eris.VOvv.conj(), P)</span>
    <span class="n">WvvVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,emfb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">WvvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">aebf</span>

    <span class="c1">#:WVVVV = eris.VVVV.copy()</span>
    <span class="c1">#:WVVVV += np.einsum(&#39;ymb,zyxemfa,zxyw-&gt;wzyaebf&#39;, t1b, eris.VOVV.conj(), P)</span>
    <span class="c1">#:WVVVV -= np.einsum(&#39;ymb,xyzfmea,xzyw-&gt;wzyaebf&#39;, t1b, eris.VOVV.conj(), P)</span>
    <span class="c1">#:WVVVV = WVVVV - WVVVV.transpose(2,1,0,5,4,3,6)</span>
    <span class="n">WVVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,emfa-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">WVVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebf</span>
        <span class="n">WVVVV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aebf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span>


<span class="c1">#TODO: merge cc_Wvvvv_half and cc_Wvvvv</span>
<div class="viewcode-block" id="cc_Wvvvv_half"><a class="viewcode-back" href="../../../../modules/pbc/cc.html#pyscf.pbc.cc.kintermediates_uhf.cc_Wvvvv_half">[docs]</a><span class="k">def</span> <span class="nf">cc_Wvvvv_half</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Similar to cc_Wvvvv, without anti-symmetrization&#39;&#39;&#39;</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="c1">#:wvvvv = eris.vvvv.copy()</span>
    <span class="c1">#:Wvvvv += np.einsum(&#39;ymb,zyxemfa,zxyw-&gt;wzyaebf&#39;, t1a, eris.vovv.conj(), P)</span>
    <span class="c1">#:Wvvvv -= np.einsum(&#39;ymb,xyzfmea,xzyw-&gt;wzyaebf&#39;, t1a, eris.vovv.conj(), P)</span>
    <span class="c1">#:Wvvvv = Wvvvv - Wvvvv.transpose(2,1,0,5,4,3,6)</span>
    <span class="n">Wvvvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,emfa-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">Wvvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebf</span>

    <span class="c1">#:WvvVV = eris.vvVV.copy()</span>
    <span class="c1">#:WvvVV -= np.einsum(&#39;xma,zxwemFB,zwxy-&gt;xzyaeBF&#39;, t1a, eris.voVV.conj(), P)</span>
    <span class="c1">#:WvvVV -= np.einsum(&#39;yMB,wyzFMea,wzyx-&gt;xzyaeBF&#39;, t1b, eris.VOvv.conj(), P)</span>
    <span class="n">WvvVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,emfb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">WvvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">aebf</span>

    <span class="c1">#:WVVVV = eris.VVVV.copy()</span>
    <span class="c1">#:WVVVV += np.einsum(&#39;ymb,zyxemfa,zxyw-&gt;wzyaebf&#39;, t1b, eris.VOVV.conj(), P)</span>
    <span class="c1">#:WVVVV -= np.einsum(&#39;ymb,xyzfmea,xzyw-&gt;wzyaebf&#39;, t1b, eris.VOVV.conj(), P)</span>
    <span class="c1">#:WVVVV = WVVVV - WVVVV.transpose(2,1,0,5,4,3,6)</span>
    <span class="n">WVVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">aebf</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">aebf</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,emfa-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">aebf</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,fmea-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">WVVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebf</span>
    <span class="k">return</span> <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span></div>

<span class="k">def</span> <span class="nf">Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>

    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span> <span class="o">=</span> <span class="n">cc_Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
            <span class="n">Wvvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,menf-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WvvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaB,meNF-&gt;aeBF&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WVVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,menf-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span>

<span class="k">def</span> <span class="nf">get_Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">kc</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nocc</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nkpts</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">kd</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">eris</span><span class="p">,</span> <span class="s1">&#39;Lpv&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Using GDF to generate Wvvvv on the fly</span>
        <span class="n">Lpv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">Lpv</span>
        <span class="n">LPV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">LPV</span>
        <span class="n">Lac</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkc,ka-&gt;Lac&#39;</span><span class="p">,</span> <span class="n">Lpv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,:</span><span class="n">nocca</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">]))</span>
        <span class="n">Lbd</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">Lpv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,:</span><span class="n">nocca</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">]))</span>
        <span class="n">Lbc</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkc,ka-&gt;Lac&#39;</span><span class="p">,</span> <span class="n">Lpv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,:</span><span class="n">nocca</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">]))</span>
        <span class="n">Lad</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">Lpv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,:</span><span class="n">nocca</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">]))</span>
        <span class="n">LAC</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,</span><span class="n">noccb</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">LPV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,:</span><span class="n">noccb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">]))</span>
        <span class="n">LBD</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,</span><span class="n">noccb</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">LPV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,:</span><span class="n">noccb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">]))</span>
        <span class="n">LBC</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,</span><span class="n">noccb</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkc,ka-&gt;Lac&#39;</span><span class="p">,</span> <span class="n">LPV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">][:,:</span><span class="n">noccb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">]))</span>
        <span class="n">LAD</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,</span><span class="n">noccb</span><span class="p">:]</span> <span class="o">-</span>
               <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lkd,kb-&gt;Lbd&#39;</span><span class="p">,</span> <span class="n">LPV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">][:,:</span><span class="n">noccb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">]))</span>
        <span class="n">vvvv</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lac,Lbd-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">Lac</span><span class="p">,</span> <span class="n">Lbd</span><span class="p">)</span>
        <span class="n">vvvv</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lbc,Lad-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">Lbc</span><span class="p">,</span> <span class="n">Lad</span><span class="p">)</span>
        <span class="n">vvVV</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lac,Lbd-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">Lac</span><span class="p">,</span> <span class="n">LBD</span><span class="p">)</span>
        <span class="n">VVVV</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lac,Lbd-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">LAC</span><span class="p">,</span> <span class="n">LBD</span><span class="p">)</span>
        <span class="n">VVVV</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Lbc,Lad-&gt;acbd&#39;</span><span class="p">,</span> <span class="n">LBC</span><span class="p">,</span> <span class="n">LAD</span><span class="p">)</span>
        <span class="n">vvvv</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nkpts</span><span class="p">)</span>
        <span class="n">vvVV</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nkpts</span><span class="p">)</span>
        <span class="n">VVVV</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nkpts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vvvv</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfa,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmea,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmeb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">vvvv</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vvvv</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,ma,nb-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvvv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,mb,na-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>

        <span class="n">vvVV</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="o">-</span><span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">vvVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmea,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="o">-</span><span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,ma,nb-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">vvVV</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>

        <span class="n">VVVV</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfa,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmea,mb-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;emfb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;fmeb,ma-&gt;aebf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">VVVV</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">VVVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,ma,nb-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcnf,mb,na-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">vvvv</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,mcnf-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
        <span class="n">vvVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaB,mcNF-&gt;acBF&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
        <span class="n">VVVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,mcnf-&gt;acbf&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vvvv</span><span class="p">,</span> <span class="n">vvVV</span><span class="p">,</span> <span class="n">VVVV</span>

<span class="k">def</span> <span class="nf">cc_Wovvo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">get_kconserv</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">Wovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WovVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WoVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOvvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kj</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">WovVO</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">WOVvo</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">kb</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span>
        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WoVVo</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOvvO</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau2</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">vovv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">VOVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">voVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">VOvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">vovv</span><span class="p">)</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">VOVV</span><span class="p">)</span>
                <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">voVV</span><span class="p">)</span>
                <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">VOvv</span><span class="p">)</span>
                <span class="c1">##### warnings for Ks</span>
                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">vovv</span><span class="p">)</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">VOVV</span><span class="p">)</span>
                <span class="n">WOvvO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">VOvv</span><span class="p">)</span>
                <span class="n">WoVVo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">voVV</span><span class="p">)</span>

                <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
                <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>

                <span class="n">WOvvO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                <span class="n">WoVVo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

                <span class="n">ooov_temp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">ooov_temp</span><span class="p">)</span>
                <span class="n">ooov_temp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">OOOV_temp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">OOOV_temp</span><span class="p">)</span>
                <span class="n">OOOV_temp</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xjnbf,xmenf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,:,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,:])</span>
                <span class="n">WOvvO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xnemf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[:,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
                <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xmenf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,:])</span>

                <span class="n">temp_ovOV_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">temp_ovOV_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                    <span class="n">temp_ovOV_1</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">temp_ovOV_2</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">kn</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)</span>
                <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">][</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjfb,xnfme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">temp_ovOV_1</span><span class="p">)</span>
                <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xnfme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">temp_ovOV_1</span><span class="p">)</span>
                <span class="n">WoVVo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xjnfb,xmfne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">temp_ovOV_2</span><span class="p">)</span>

                <span class="n">temp_OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[:,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xmenf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">temp_OVOV</span><span class="p">)</span>
                <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xjnbf,xmenf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,:,</span><span class="n">kb</span><span class="p">],</span> <span class="n">temp_OVOV</span><span class="p">)</span>
                <span class="n">temp_OVOV</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">temp_ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[:,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjbf,xnemf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">[:,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">temp_ovov</span><span class="p">)</span>
                <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xnjfb,xnemf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">temp_ovov</span><span class="p">)</span>
                <span class="n">temp_ovov</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">Wovvo</span><span class="p">,</span> <span class="n">WovVO</span><span class="p">,</span> <span class="n">WOVvo</span><span class="p">,</span> <span class="n">WOVVO</span><span class="p">,</span> <span class="n">WoVVo</span><span class="p">,</span> <span class="n">WOvvO</span>

<span class="k">def</span> <span class="nf">_cc_Wovvo_k0k2</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">k2</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t1b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">get_kconserv</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">Wovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WovVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WoVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOvvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="c1">#:P = kconserv_mat(cc.nkpts, kconserv)</span>
    <span class="c1">#:Wovvo = np.einsum(&#39;xyzaijb,xzyw-&gt;yxwiabj&#39;, eris.voov, P).conj()</span>
    <span class="c1">#:WovVO = np.einsum(&#39;xyzaijb,xzyw-&gt;yxwiabj&#39;, eris.voOV, P).conj()</span>
    <span class="c1">#:WOVvo = np.einsum(&#39;wzybjia,xzyw-&gt;yxwiabj&#39;, eris.voOV, P)</span>
    <span class="c1">#:WOVVO = np.einsum(&#39;xyzaijb,xzyw-&gt;yxwiabj&#39;, eris.VOOV, P).conj()</span>
    <span class="c1">#:Wovvo-= np.einsum(&#39;xyzijab,xzyw-&gt;xwzibaj&#39;, eris.oovv, P)</span>
    <span class="c1">#:WOVVO-= np.einsum(&#39;xyzijab,xzyw-&gt;xwzibaj&#39;, eris.OOVV, P)</span>
    <span class="c1">#:WoVVo = np.einsum(&#39;xyzijab,xzyw-&gt;xwzibaj&#39;, eris.ooVV, -P)</span>
    <span class="c1">#:WOvvO = np.einsum(&#39;xyzijab,xzyw-&gt;xwzibaj&#39;, eris.OOvv, -P)</span>
    <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">ka</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span>
        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">WovVO</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">WOVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span>
        <span class="n">Wovvo</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WoVVo</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WOvvO</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k2</span><span class="p">]</span>
        <span class="n">vovv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">VOVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">voVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">VOvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">vovv</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">VOVV</span><span class="p">)</span>
        <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">voVV</span><span class="p">)</span>
        <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf, emfb-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">VOvv</span><span class="p">)</span>

        <span class="n">Wovvo</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">vovv</span><span class="p">)</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">VOVV</span><span class="p">)</span>
        <span class="n">WOvvO</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">VOvv</span><span class="p">)</span>
        <span class="n">WoVVo</span><span class="p">[</span><span class="n">kj</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je, emfb-&gt;mfbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">voVV</span><span class="p">)</span>

        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
        <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
        <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">k2</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>

        <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>
        <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>
        <span class="n">WoVVo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>
        <span class="n">WOvvO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, mjne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njfb,nfme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njfb,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">k2</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,nfme-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
            <span class="n">WoVVo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,mfne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOvvO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njbf,nemf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">k2</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">kn</span> <span class="o">==</span> <span class="n">k2</span> <span class="ow">and</span> <span class="n">kf</span> <span class="o">==</span> <span class="n">kj</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,jf-&gt;menj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">])</span>
                <span class="n">tmp</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nemf,jf-&gt;menj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">])</span>
                <span class="n">Wovvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,menj-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,jf-&gt;menj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">])</span>
                <span class="n">tmp</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nemf,jf-&gt;menj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">])</span>
                <span class="n">WOVVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,menj-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>

                <span class="n">WovVO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb,menf-&gt;mebj&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
                <span class="n">WOVvo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb,nfme-&gt;mebj&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>
                <span class="n">WoVVo</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb,mfne-&gt;mebj&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">k0</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
                <span class="n">WOvvO</span><span class="p">[</span><span class="n">ke</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb,nemf-&gt;mebj&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">k0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Wovvo</span><span class="p">,</span> <span class="n">WovVO</span><span class="p">,</span> <span class="n">WOVvo</span><span class="p">,</span> <span class="n">WOVVO</span><span class="p">,</span> <span class="n">WoVVo</span><span class="p">,</span> <span class="n">WOvvO</span>


<span class="k">def</span> <span class="nf">kconserv_mat</span><span class="p">(</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">kconserv</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
                <span class="n">P</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ka</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="k">def</span> <span class="nf">Foo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">Fova</span><span class="p">,</span> <span class="n">Fovb</span> <span class="o">=</span> <span class="n">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="n">Fooa</span><span class="p">,</span> <span class="n">Foob</span> <span class="o">=</span> <span class="n">cc_Foo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">Fooa</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,me-&gt;mi&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span><span class="n">Fova</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
        <span class="n">Foob</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,me-&gt;mi&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span><span class="n">Fovb</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Fooa</span><span class="p">,</span> <span class="n">Foob</span>

<span class="k">def</span> <span class="nf">Fvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">Fova</span><span class="p">,</span> <span class="n">Fovb</span> <span class="o">=</span> <span class="n">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="n">Fvva</span><span class="p">,</span> <span class="n">Fvvb</span> <span class="o">=</span> <span class="n">cc_Fvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ka</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">Fvva</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="n">Fova</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">Fvvb</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="n">Fovb</span><span class="p">[</span><span class="n">ka</span><span class="p">],</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ka</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Fvva</span><span class="p">,</span> <span class="n">Fvvb</span>

<span class="k">def</span> <span class="nf">Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">Fme</span> <span class="o">=</span> <span class="n">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Fme</span>

<span class="k">def</span> <span class="nf">Wvvov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">Wvvov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WvvOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WVVov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WVVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kn</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span>
        <span class="n">ka</span> <span class="o">=</span> <span class="n">kn</span>
        <span class="n">Wvvov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WVVov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WvvOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WVVOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

        <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Wvvov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,nemf-&gt;aemf&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">WvvOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,neMF-&gt;aeMF&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
        <span class="n">WVVov</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NA,NEmf-&gt;AEmf&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
        <span class="n">WVVOV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NA,NEMF-&gt;AEMF&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">kn</span><span class="p">],</span><span class="n">OVOV</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Wvvov</span><span class="p">,</span> <span class="n">WvvOV</span><span class="p">,</span> <span class="n">WVVov</span><span class="p">,</span> <span class="n">WVVOV</span>

<span class="k">def</span> <span class="nf">Wvvvo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">fova</span><span class="p">,</span> <span class="n">fovb</span> <span class="o">=</span> <span class="n">cc_Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>

    <span class="n">Wvvvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WvvVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WVVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WVVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ki</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="c1"># - &lt;mb||ef&gt; t2(miaf)</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

            <span class="n">aebi</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,miaf-&gt;aebi&#39;</span><span class="p">,</span><span class="n">ovvv</span><span class="p">,</span><span class="n">t2aa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
            <span class="n">aebi</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFbe,iMaF-&gt;aebi&#39;</span><span class="p">,</span><span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
            <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aebi</span>
            <span class="c1"># P(ab) for all alpha spin</span>
            <span class="n">Wvvvo</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebi</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEbf,iMfA-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">OVvv</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">])</span>
            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meBF,mIaF-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">ovVV</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

            <span class="n">AEBI</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEBF,MIAF-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">OVVV</span><span class="p">,</span><span class="n">t2bb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
            <span class="n">AEBI</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfBE,mIfA-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">t2ab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">])</span>
            <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">AEBI</span>
            <span class="c1"># P(ab) for all beta spin</span>
            <span class="n">WVVVO</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">AEBI</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># - t1(ma) (&lt;mb||ei&gt; - t2(nibf) &lt;mn||ef&gt;)</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">ka</span>
        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOov</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">ovVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">OVVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">tmp1aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ovOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">tmp1aa</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nibf,menf-&gt;mebi&#39;</span><span class="p">,</span><span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span>
            <span class="n">tmp1aa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNbF,meNF-&gt;mebi&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovOV</span><span class="p">)</span>

            <span class="n">tmp1ab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfB,menf-&gt;meBI&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span>
            <span class="n">tmp1ab</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIBF,meNF-&gt;meBI&#39;</span><span class="p">,</span><span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovOV</span><span class="p">)</span>

            <span class="n">tmp1ba</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNbF,MENF-&gt;MEbi&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span>
            <span class="n">tmp1ba</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nibf,MEnf-&gt;MEbi&#39;</span><span class="p">,</span><span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVov</span><span class="p">)</span>

            <span class="n">tmp1bb</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIBF,MENF-&gt;MEBI&#39;</span><span class="p">,</span><span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span>
            <span class="n">tmp1bb</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfB,MEnf-&gt;MEBI&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">OVov</span><span class="p">)</span>

        <span class="n">aebi</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mebi-&gt;aebi&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],(</span><span class="n">ovvo</span><span class="o">+</span><span class="n">tmp1aa</span><span class="p">))</span>
        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aebi</span>

        <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MEbi-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">OVvo</span><span class="o">+</span><span class="n">tmp1ba</span><span class="p">)</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,meBI-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span><span class="n">ovVO</span><span class="o">+</span><span class="n">tmp1ab</span><span class="p">)</span>

        <span class="n">AEBI</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MEBI-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],(</span><span class="n">OVVO</span><span class="o">+</span><span class="n">tmp1bb</span><span class="p">))</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">AEBI</span>


    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ki</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="c1"># P(ab) &lt;mb||ef&gt; t2(miaf) (alpha alpha beta beta) and (beta beta alpha alpha)</span>
        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfAE,mibf-&gt;AEbi&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEAF,iMbF-&gt;AEbi&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFae,MIBF-&gt;aeBI&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,mIfB-&gt;aeBI&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">])</span>

        <span class="c1"># P(ab) -t1(ma) (&lt;mb||ei&gt; - t2(nibf) &lt;mn||ef&gt;) for all spin configurations</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">kb</span>
        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">tmp1aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tmp1bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ovOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">tmp1aa</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;niaf,menf-&gt;meai&#39;</span><span class="p">,</span><span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span>
            <span class="n">tmp1aa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNaF,meNF-&gt;meai&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">ovOV</span><span class="p">)</span>

            <span class="n">tmp1ab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIaF,MFne-&gt;MeaI&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">tmp1ba</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNfA,mfNE-&gt;mEAi&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">tmp1bb</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIAF,MENF-&gt;MEAI&#39;</span><span class="p">,</span><span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span>
            <span class="n">tmp1bb</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfA,MEnf-&gt;MEAI&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">OVov</span><span class="p">)</span>

        <span class="n">aebi</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,meai-&gt;aebi&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],(</span><span class="n">ovvo</span><span class="o">+</span><span class="n">tmp1aa</span><span class="p">))</span>
        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aebi</span>

        <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mEAi-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="o">-</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">tmp1ba</span><span class="p">)</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MB,MeaI-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="o">-</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">tmp1ab</span><span class="p">)</span>

        <span class="n">AEBI</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MB,MEAI-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">[</span><span class="n">km</span><span class="p">],(</span><span class="n">OVVO</span><span class="o">+</span><span class="n">tmp1bb</span><span class="p">))</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">AEBI</span>

    <span class="c1"># Remaining terms</span>
    <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ki</span> <span class="o">=</span> <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,miab-&gt;aebi&#39;</span><span class="p">,</span><span class="n">fova</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span><span class="n">t2aa</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,iMbA-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">fovb</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,mIaB-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">fova</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span><span class="n">t2ab</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,MIAB-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">fovb</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span><span class="n">t2bb</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

        <span class="n">Wvvvv</span><span class="p">,</span> <span class="n">WvvVV</span><span class="p">,</span> <span class="n">WVVVV</span> <span class="o">=</span> <span class="n">get_Wvvvv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">)</span>
        <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;if,aebf-&gt;aebi&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">Wvvvv</span><span class="p">)</span>
        <span class="n">WVVvo</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">ka</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,aeBF-&gt;BFai&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ke</span><span class="p">],</span> <span class="n">WvvVV</span><span class="p">)</span>
        <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IF,aeBF-&gt;aeBI&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">WvvVV</span><span class="p">)</span>
        <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IF,AEBF-&gt;AEBI&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">WVVVV</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
            <span class="n">ovoo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovOO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">ooOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">OOov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>

            <span class="n">OVoo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVOO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Wvvvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meni,mnab-&gt;aebi&#39;</span><span class="p">,</span><span class="n">ovoo</span><span class="p">,</span><span class="n">tauaa</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEni,nMbA-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">OVoo</span><span class="p">,</span><span class="n">tauab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WVVvo</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;miNE,mNbA-&gt;AEbi&#39;</span><span class="p">,</span><span class="n">ooOV</span><span class="p">,</span><span class="n">tauab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNI,mNaB-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">ovOO</span><span class="p">,</span><span class="n">tauab</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>
            <span class="n">WvvVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIne,nMaB-&gt;aeBI&#39;</span><span class="p">,</span><span class="n">OOov</span><span class="p">,</span><span class="n">tauab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

            <span class="n">WVVVO</span><span class="p">[</span><span class="n">ka</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MENI,MNAB-&gt;AEBI&#39;</span><span class="p">,</span><span class="n">OVOO</span><span class="p">,</span><span class="n">taubb</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ka</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Wvvvo</span><span class="p">,</span> <span class="n">WvvVO</span><span class="p">,</span> <span class="n">WVVvo</span><span class="p">,</span> <span class="n">WVVVO</span>


<span class="k">def</span> <span class="nf">Woooo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">tau_aa</span><span class="p">,</span> <span class="n">tau_ab</span><span class="p">,</span> <span class="n">tau_bb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">tmp_aaaaJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_aaaaJ</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yie, xmjne-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_bbbbJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_bbbbJ</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yie, xmjne-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="c1">#tmp_aabbJ = einsum(&#39;xje, ymine-&gt;yxminj&#39;, t1b, eris.ooOV[km,:,kn])</span>
            <span class="c1">#tmp_bbaaJ = einsum(&#39;xje, ymine-&gt;yxminj&#39;, t1a, eris.OOov[km,:,kn])</span>
            <span class="c1">#tmp_abbaJ = -einsum(&#39;yie,xmjne-&gt;yxminj&#39;, t1b, eris.ooOV[km,:,kn])</span>
            <span class="n">tmp_baabJ</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yie,xmjne-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">tmp_aabbJ</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xje, ymine-&gt;yxminj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,:,</span><span class="n">kn</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_aaaaJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
                <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_bbbbJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
                <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_aabbJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span>
                <span class="n">WooOO</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp_baabJ</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
                <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>

    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">Woooo</span> <span class="o">-</span> <span class="n">Woooo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">WOOOO</span> <span class="o">-</span> <span class="n">WOOOO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span>

            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Woooo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,menf-&gt;minj&#39;</span><span class="p">,</span> <span class="n">tau_aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">ke</span><span class="p">],</span>      <span class="n">ovov</span><span class="p">)</span>
            <span class="n">WOOOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IJEF,MENF-&gt;MINJ&#39;</span><span class="p">,</span> <span class="n">tau_bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">ke</span><span class="p">],</span>      <span class="n">OVOV</span><span class="p">)</span>
            <span class="n">WooOO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span> <span class="o">+=</span>     <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJeF,meNF-&gt;miNJ&#39;</span><span class="p">,</span> <span class="n">tau_ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">ke</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">])</span>

    <span class="n">WOOoo</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">Woooo</span><span class="p">,</span> <span class="n">WooOO</span><span class="p">,</span> <span class="n">WOOoo</span><span class="p">,</span> <span class="n">WOOOO</span>

<span class="k">def</span> <span class="nf">Woovo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">Woovo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">nkpts</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">OOOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,jnbe-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">ooov</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;miNE,jNbE-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,nJeB-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">ooov</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;miNE,JNBE-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MINE,jNbE-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIne,jnbe-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MINE,JNBE-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIne,nJeB-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="c1"># P(ij)</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span>
            <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">OOOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mjne,inbe-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">ooov</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mjNE,iNbE-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NJme,iNeB-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njME,nIbE-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MJNE,INBE-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MJne,nIeB-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>

        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ovVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voOV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">OVvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOov</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mebj-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">ovvo</span><span class="p">)</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,meBJ-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">ovVO</span><span class="p">)</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,MEbj-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">OVvo</span><span class="p">)</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,MEBJ-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">OVVO</span><span class="p">)</span>
        <span class="c1">#P(ij)</span>
        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVVO</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,mebi-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">ovvo</span><span class="p">)</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,miBE-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,MIbe-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,MEBI-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">OVVO</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">kf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kf</span><span class="p">]</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,njbf,menf-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,jNbF,meNF-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,nJfB,menf-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,NJBF,meNF-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,jNbF,MENF-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span> <span class="o">+</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,njbf,MEnf-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,NJBF,MENF-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,nJfB,MEnf-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="c1">#P(ij)</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kf</span><span class="p">]</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,nibf,menf-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">ovov</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,iNbF,meNF-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,iNfB,mfNE-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">kn</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,nIbF,MFne-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">kn</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,NIBF,MENF-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">OVOV</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,nIfB,MEnf-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kj</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

    <span class="n">Fme</span><span class="p">,</span> <span class="n">FME</span> <span class="o">=</span> <span class="n">Fov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="n">Wminj</span><span class="p">,</span> <span class="n">WmiNJ</span><span class="p">,</span> <span class="n">WMInj</span><span class="p">,</span> <span class="n">WMINJ</span> <span class="o">=</span> <span class="n">Woooo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>

        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ijbe-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">Fme</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,iJeB-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">Fme</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">km</span><span class="p">])</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,jIbE-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">FME</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,IJBE-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">FME</span><span class="p">[</span><span class="n">km</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

        <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, minj-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">Wminj</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">])</span>
        <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB, miNJ-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">WmiNJ</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">])</span>
        <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb, njMI-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">WmiNJ</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">km</span><span class="p">])</span>
        <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB, MINJ-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">],</span> <span class="n">WMINJ</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">-</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kf</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ke</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">Woovo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,ijef-&gt;mibj&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="n">WooVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meBF,iJeF-&gt;miBJ&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>
            <span class="n">WOOvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEbf,jIfE-&gt;MIbj&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">tauab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kf</span><span class="p">])</span>
            <span class="n">WOOVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEBF,IJEF-&gt;MIBJ&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">taubb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">ke</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Woovo</span><span class="p">,</span> <span class="n">WooVO</span><span class="p">,</span> <span class="n">WOOvo</span><span class="p">,</span> <span class="n">WOOVO</span>


<span class="k">def</span> <span class="nf">Wooov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">kconserv</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">Wooov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooov</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">WooOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">WOOov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">WOOOV</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">Wooov</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yif,xyzmfne-&gt;xyzmine&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yif, zyxnfme-&gt;xyzmine&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
    <span class="n">WooOV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yif,xyzmfNE-&gt;xyzmiNE&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
    <span class="n">WOOov</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yIF,xyzMFne-&gt;xyzMIne&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">)</span>
    <span class="n">WOOOV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yIF,xyzMFNE-&gt;xyzMINE&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span> <span class="o">-</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yIF, zyxNFME-&gt;xyzMINE&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Wooov</span><span class="p">,</span> <span class="n">WooOV</span><span class="p">,</span> <span class="n">WOOov</span><span class="p">,</span> <span class="n">WOOOV</span>

<span class="k">def</span> <span class="nf">Wovvo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">Wovvo</span><span class="p">,</span> <span class="n">WovVO</span><span class="p">,</span> <span class="n">WOVvo</span><span class="p">,</span> <span class="n">WOVVO</span><span class="p">,</span> <span class="n">WoVVo</span><span class="p">,</span> <span class="n">WOvvO</span> <span class="o">=</span> <span class="n">cc_Wovvo</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">km</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kj</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">kn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">km</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kn</span><span class="p">]</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,menf-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,mfne-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">Wovvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,meNF-&gt;mebj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,MENF-&gt;MEbj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,MFNE-&gt;MEbj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOVvo</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnbf,MEnf-&gt;MEbj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,menf-&gt;meBJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,mfne-&gt;meBJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WovVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JNBF,meNF-&gt;meBJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

            <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JNBF,MENF-&gt;MEBJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JNBF,MFNE-&gt;MEBJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">kj</span><span class="p">,</span><span class="n">kn</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">kf</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>
            <span class="n">WOVVO</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,MEnf-&gt;MEBJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kn</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kf</span><span class="p">],</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">km</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kn</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Wovvo</span><span class="p">,</span> <span class="n">WovVO</span><span class="p">,</span> <span class="n">WOVvo</span><span class="p">,</span> <span class="n">WOVVO</span>

<span class="k">def</span> <span class="nf">W1oovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Woovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kd</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">voov</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOOV</span><span class="p">[</span><span class="n">kb</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">kl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                    <span class="n">kc</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">kl</span><span class="p">]</span>
                    <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lckd,ilbc-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                    <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ldkc,ilbc-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kd</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                    <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;LCkd,iLbC-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

                    <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kcLD,iLcB-&gt;kiBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kl</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">])</span>
                    <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;KCld,lIbC-&gt;KIbd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVov</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kl</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>

                    <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;LCKD,ILBC-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                    <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;LDKC,ILBC-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kd</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kl</span><span class="p">,</span><span class="n">kb</span><span class="p">])</span>
                    <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lcKD,lIcB-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">kc</span><span class="p">,</span><span class="n">kk</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">kl</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kc</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Woovv</span><span class="p">,</span> <span class="n">WooVV</span><span class="p">,</span> <span class="n">WOOvv</span><span class="p">,</span> <span class="n">WOOVV</span>

<span class="k">def</span> <span class="nf">W2oovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">khelper</span><span class="o">.</span><span class="n">kconserv</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Woovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WooVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WOOVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">WWooov</span><span class="p">,</span> <span class="n">WWooOV</span><span class="p">,</span> <span class="n">WWOOov</span><span class="p">,</span> <span class="n">WWOOOV</span> <span class="o">=</span> <span class="n">Wooov</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">kconserv</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
                <span class="n">kd</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kild,lb-&gt;kibd&#39;</span><span class="p">,</span><span class="n">WWooov</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span><span class="o">-</span><span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
                <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kiLD,LB-&gt;kiBD&#39;</span><span class="p">,</span><span class="n">WWooOV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span><span class="o">-</span><span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
                <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;KIld,lb-&gt;KIbd&#39;</span><span class="p">,</span><span class="n">WWOOov</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span><span class="o">-</span><span class="n">t1a</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>
                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;KILD,LB-&gt;KIBD&#39;</span><span class="p">,</span><span class="n">WWOOOV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">],</span><span class="o">-</span><span class="n">t1b</span><span class="p">[</span><span class="n">kb</span><span class="p">])</span>

                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ckdb,ic-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
                <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;dkcb,ic-&gt;kibd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">vovv</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>

                <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ckDB,ic-&gt;kiBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">voVV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1a</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
                <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;CKdb,IC-&gt;KIbd&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOvv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>

                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;CKDB,IC-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>
                <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;DKCB,IC-&gt;KIBD&#39;</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">VOVV</span><span class="p">[</span><span class="n">kd</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">t1b</span><span class="p">[</span><span class="n">ki</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Woovv</span><span class="p">,</span> <span class="n">WooVV</span><span class="p">,</span> <span class="n">WOOvv</span><span class="p">,</span> <span class="n">WOOVV</span>

<span class="k">def</span> <span class="nf">Woovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">nkpts</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Woovv</span><span class="p">,</span> <span class="n">WooVV</span><span class="p">,</span> <span class="n">WOOvv</span><span class="p">,</span> <span class="n">WOOVV</span> <span class="o">=</span> <span class="n">W1oovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="n">WWoovv</span><span class="p">,</span> <span class="n">WWooVV</span><span class="p">,</span> <span class="n">WWOOvv</span><span class="p">,</span> <span class="n">WWOOVV</span> <span class="o">=</span> <span class="n">W2oovv</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">Woovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+</span> <span class="n">WWoovv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">WooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+</span> <span class="n">WWooVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">WOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+</span> <span class="n">WWOOvv</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
        <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">=</span> <span class="n">WOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span> <span class="o">+</span> <span class="n">WWOOVV</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kb</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Woovv</span><span class="p">,</span> <span class="n">WooVV</span><span class="p">,</span> <span class="n">WOOvv</span><span class="p">,</span> <span class="n">WOOVV</span>

<span class="c1"># vvvv is a string, (&#39;oooo&#39;, &#39;ooov&#39;, ..., &#39;vvvv&#39;)</span>
<span class="c1"># orbspin can be accessed through general spin-orbital kintermediates eris</span>
<span class="c1"># orbspin = eris.mo_coeff.orbspin</span>
<span class="k">def</span> <span class="nf">_eri_spin2spatial</span><span class="p">(</span><span class="n">chemist_eri_spin</span><span class="p">,</span> <span class="n">vvvv</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">orbspin</span><span class="p">,</span> <span class="n">cross_ab</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nocc_b</span> <span class="o">=</span> <span class="n">nocc</span>
    <span class="n">nocc</span> <span class="o">=</span> <span class="n">nocc_a</span> <span class="o">+</span> <span class="n">nocc_b</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbspin</span><span class="p">)</span>
    <span class="n">idxoa</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxob</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxva</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxvb</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">select_idx</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idxoa</span><span class="p">,</span> <span class="n">idxob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idxva</span><span class="p">,</span> <span class="n">idxvb</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vvvv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">idx1a</span><span class="p">,</span> <span class="n">idx1b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">idx2a</span><span class="p">,</span> <span class="n">idx2b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span>

    <span class="n">idx1a</span><span class="p">,</span> <span class="n">idx1b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">idx2a</span><span class="p">,</span> <span class="n">idx2b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">idx3a</span><span class="p">,</span> <span class="n">idx3b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">idx4a</span><span class="p">,</span> <span class="n">idx4b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">eri_aaaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4a</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">eri_aabb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">eri_bbaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4a</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">eri_bbbb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
        <span class="n">eri_abba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4a</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">eri_baab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">get_kconserv</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kk</span><span class="p">]</span>
        <span class="n">eri_aaaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>
        <span class="n">eri_aabb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>
        <span class="n">eri_bbaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>
        <span class="n">eri_bbbb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
            <span class="n">eri_abba</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>
            <span class="n">eri_baab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">chemist_eri_spin</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eri_aaaa</span><span class="p">,</span> <span class="n">eri_aabb</span><span class="p">,</span> <span class="n">eri_bbaa</span><span class="p">,</span> <span class="n">eri_bbbb</span><span class="p">,</span> <span class="n">eri_abba</span><span class="p">,</span> <span class="n">eri_baab</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eri_aaaa</span><span class="p">,</span> <span class="n">eri_aabb</span><span class="p">,</span> <span class="n">eri_bbaa</span><span class="p">,</span> <span class="n">eri_bbbb</span>

<span class="k">def</span> <span class="nf">_eri_spatial2spin</span><span class="p">(</span><span class="n">eri_aa_ab_ba_bb</span><span class="p">,</span> <span class="n">vvvv</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">orbspin</span><span class="p">,</span> <span class="n">cross_ab</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nocc_a</span><span class="p">,</span> <span class="n">nocc_b</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">nocc</span>
    <span class="n">nocc</span> <span class="o">=</span> <span class="n">nocc_a</span> <span class="o">+</span> <span class="n">nocc_b</span>
    <span class="n">nkpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">orbspin</span><span class="p">)</span>
    <span class="n">idxoa</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxob</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxva</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>
    <span class="n">idxvb</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">select_idx</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idxoa</span><span class="p">,</span> <span class="n">idxob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idxva</span><span class="p">,</span> <span class="n">idxvb</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vvvv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">idx1a</span><span class="p">,</span> <span class="n">idx1b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">idx2a</span><span class="p">,</span> <span class="n">idx2b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fa</span><span class="p">,</span> <span class="n">fb</span> <span class="o">=</span> <span class="n">eri_aa_ab_ba_bb</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
            <span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="n">idx1a</span><span class="p">,</span> <span class="n">idx1b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">idx2a</span><span class="p">,</span> <span class="n">idx2b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">idx3a</span><span class="p">,</span> <span class="n">idx3b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">idx4a</span><span class="p">,</span> <span class="n">idx4b</span> <span class="o">=</span> <span class="n">select_idx</span><span class="p">(</span><span class="n">vvvv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
        <span class="n">eri_aaaa</span><span class="p">,</span> <span class="n">eri_aabb</span><span class="p">,</span> <span class="n">eri_bbaa</span><span class="p">,</span> <span class="n">eri_bbbb</span><span class="p">,</span> <span class="n">eri_abba</span><span class="p">,</span> <span class="n">eri_baab</span> <span class="o">=</span> <span class="n">eri_aa_ab_ba_bb</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eri_aaaa</span><span class="p">,</span> <span class="n">eri_aabb</span><span class="p">,</span> <span class="n">eri_bbaa</span><span class="p">,</span> <span class="n">eri_bbbb</span> <span class="o">=</span> <span class="n">eri_aa_ab_ba_bb</span>
    <span class="n">eri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span><span class="n">nkpts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx1a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx1b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">idx2a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">idx3a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx3b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">idx4a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx4b</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="n">kconserv</span> <span class="o">=</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">get_kconserv</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">kpts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">kpts_helper</span><span class="o">.</span><span class="n">loop_kkk</span><span class="p">(</span><span class="n">nkpts</span><span class="p">):</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="n">kconserv</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span> <span class="n">kj</span><span class="p">,</span> <span class="n">kk</span><span class="p">]</span>
        <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_aaaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>
        <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_aabb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>
        <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_bbaa</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>
        <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_bbbb</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cross_ab</span><span class="p">:</span>
            <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1a</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2b</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3b</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4a</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_abba</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>
            <span class="n">eri</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">idx1b</span><span class="p">[</span><span class="n">ki</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx2a</span><span class="p">[</span><span class="n">kj</span><span class="p">][:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx3a</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">idx4b</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eri_baab</span><span class="p">[</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">eri</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2019, The PySCF Developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>